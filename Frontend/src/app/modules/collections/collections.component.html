<!-- <app-search-header></app-search-header> -->
<global-progress *ngIf="globalProgress"></global-progress>
<main-nav
    *ngIf="mainnav"
    #mainNav
    [create]="{
        allowed: !isGuest && isAllowedToEditCollection(),
        allowBinary: !isRootLevelCollection() && isAllowedToEditCollection(),
        parent: collectionContent ? collectionContent.node : null
    }"
    [title]="'COLLECTIONS.TITLE'"
    [currentScope]="'collections'"
    [searchEnabled]="false"
    (onCreate)="addNodesToCollection($event)"
></main-nav>
<tutorial
    [element]="tutorialElement"
    [heading]="'COLLECTIONS.TUTORIAL_HEADING'"
    [description]="'COLLECTIONS.TUTORIAL_DESCRIPTION'"
    [showSkip]="false"
></tutorial>
<infobar
    [title]="infoTitle"
    [message]="infoMessage"
    [buttons]="infoButtons"
    [isCancelable]="true"
    (onCancel)="infoClose()"
></infobar>
<mat-tab-group
    mat-stretch-tabs
    color="dark"
    [(selectedIndex)]="tabSelectedIndex"
    *ngIf="showTabs()"
>
    <mat-tab *ngIf="!isGuest" label="{{ 'COLLECTIONS.TAB.MY' | translate }}"></mat-tab>
    <mat-tab *ngIf="!isGuest" label="{{ 'COLLECTIONS.TAB.EDU_GROUPS' | translate }}"></mat-tab>
    <mat-tab
        *ngIf="hasEditorial"
        label="{{ 'COLLECTIONS.TAB.TYPE_EDITORIAL' | translate }}"
    ></mat-tab>
    <mat-tab
        *ngIf="hasMediacenter"
        label="{{ 'COLLECTIONS.TAB.TYPE_MEDIA_CENTER' | translate }}"
    ></mat-tab>
    <mat-tab
        label="{{ 'COLLECTIONS.TAB.EDU_ALL' | translate }}"
        (click)="tabSelected = 'EDU_ALL'"
    ></mat-tab>
</mat-tab-group>

<div class="alignWithBanner">
    <!-- collection header -->
    <div
        *ngIf="!isRootLevelCollection() && !isLoading && isReady && tabSelected.length >= -1"
        class="collections-header"
        [class.alignWithBanner]="isMobileWidth()"
        [class.scrollWithBanner]="!isMobileWidth()"
        [class.dark-color]="isBrightColor()"
        [style.background-color]="collectionContent.node.collection.color"
    >
        <div class="card-collection-image-container" style="width:100%;">
            <div
                *ngIf="collectionContent.node.preview.isIcon"
                style="width: 250px; height: 200px; margin-left: auto; margin-right: auto;"
            >
                <div class="card-image-icon-container">
                    <div
                        class="card-image-icon-circle"
                        [style.cursor]="isAllowedToEditCollection() ? 'pointer' : 'auto'"
                        (click)="collectionEdit()"
                    >
                        <i
                            class="material-icons"
                            [style.color]="collectionContent.node.collection.color"
                        >
                            layers
                        </i>
                    </div>
                </div>
            </div>

            <div
                *ngIf="!collectionContent.node.preview.isIcon"
                class="card-image-icon-container"
            >
                <img
                    class="collection-header-image"
                    [src]="
                        collectionContent.node.preview.url + '&crop=true&width=400&height=350'
                    "
                    role="presentation"
                />
            </div>
            <div
                *ngIf="isAllowedToEditCollection()"
                (click)="collectionEdit()"
                class="big-edit-button"
            ></div>
        </div>
        <div class="collections-header-textarea">
            <actionbar
                #actionbarCollection
                class="collection-option"
                [numberOfAlwaysVisibleOptions]="1"
                [numberOfAlwaysVisibleOptionsMobile]="1"
                appearance="round"
                [style]="'flat'"
                [dropdownPosition]="'right'"
            ></actionbar>
            <div
                class="collection-new-preview-headline collections-header-texttop"
                style="overflow:hidden;"
            >
                {{ collectionContent.node.title }}
            </div>

            <div
                *ngIf="collectionContent.node.collection.childCollectionsCount"
                class="collection-new-preview-subline collections-header-texttop"
            >
                {{ collectionContent.node.collection.childCollectionsCount }}
                {{ 'COLLECTION.INFO_REFERENCES_MULTI' | translate }}
            </div>
            <div
                *ngIf="collectionContent.node.collection.childReferencesCount"
                class="collection-new-preview-subline collections-header-texttop"
            >
                {{ collectionContent.node.collection.childReferencesCount }}
                {{ 'COLLECTION.INFO_CHILDS_MULTI' | translate }}
            </div>

            <div class="collection-new-preview-infoline">
                <i class="material-icons icon-bottom">person</i>
                <span *ngIf="!collectionContent.node.collection.authorFreetext">{{
                    collectionContent.node.owner | authorityName
                }}</span>
                <span *ngIf="collectionContent.node.collection.authorFreetext">{{
                    collectionContent.node.collection.authorFreetext
                }}</span>
            </div>

            <div class="collection-new-preview-infoline">
                <i class="material-icons icon-bottom">{{ getScopeInfo().icon }}</i
                >&nbsp;{{ 'COLLECTION.SCOPE.' + getScopeInfo().scopeName | translate }}
            </div>

            <div class="collection-description" style="margin-top:16px;opacity:0.85;">
                {{ 'collections_description' | translate }}
            </div>

            <div class="collection-description" style="margin-top:5px;">
                {{ collectionContent.node.collection.description }}
                <span
                    *ngIf="
                        collectionContent.node.collection.description == null ||
                        collectionContent.node.collection.description.length == 0
                    "
                    style="padding:2px;"
                >
                    -
                </span>
            </div>
        </div>
    </div>

    <div [class.collectionsContainerTabs]="showTabs()" class="collectionsContainer">
        <section
            *ngIf="isLoading || !isReady"
            class="collections-loading-div"
            style="padding-top: 24px;text-align: center;"
        >
            <spinner></spinner>
        </section>
        <div class="collections-master-div" [class.collections-master-div-notabs]="!showTabs()">
            <!-- breadcrumbs -->
            <div class="breadcrumb-space" *ngIf="!isRootLevelCollection() && !isLoading">
                <breadcrumbs
                    class="collections-breadcrumb"
                    [home]="'COLLECTIONS.TAB.' + tabSelected"
                    [breadcrumbsAsNode]="path"
                    [canDrop]="canDropOnCollection"
                    (onDrop)="dropOnCollection($event)"
                    (onClick)="openBreadcrumb($event)"
                ></breadcrumbs>
            </div>

            <a
                *ngIf="!isLoading && isGuest"
                class="clickable switchToSearch"
                title="{{ 'COLLECTIONS.TO_SEARCH' | translate }}"
                tabindex="0"
                (click)="navigateToSearch()"
                (keypress)="$event.which === 13 ? navigateToSearch() : 0"
                >{{ 'COLLECTIONS.TO_SEARCH' | translate }}
                <i class="material-icons">arrow_forward</i>
            </a>

            <!-- content (collection cards) if not error -->

            <section class="collections-cards-div" *ngIf="!isLoading">
                <div
                    class="section-headline"
                    *ngIf="isAllowedToEditCollection() || collectionContent.collections.length"
                >
                    <span *ngIf="isRootLevelCollection()">{{
                        'COLLECTIONS.TAB.' + tabSelected + '_LONG' | translate
                    }}</span>
                    <span *ngIf="!isRootLevelCollection()">{{
                        'COLLECTION.INFO_REFERENCES_MULTI' | translate
                    }}</span>
                </div>

                <!-- COLLECTION CARDS -->
                <listTable
                    #listCollections
                    [listClass]="'subcollections'"
                    [optionItems]="
                        isAllowedToEditCollection()
                        ? [createSubCollectionOptionItem]
                        : []
                    "
                    [hasHeading]="false"
                    [isLoading]="isLoading"
                    [viewType]="getCollectionViewType()"
                    [dragDrop]="true"
                    [canDrop]="canDropOnCollection"
                    (onDrop)="dropOnCollection($event)"
                    [columns]="collectionsColumns"
                    [isClickable]="true"
                    (clickRow)="onCollectionsClick($event.node)"
                    (doubleClickRow)="onCollectionsClick($event)"
                    [nodes]="collectionContent.collections"
                    [isLoading]="collectionContent.collectionsLoading"
                    [hasMore]="
                        collectionContent.collections.length <
                        collectionContent.collectionsPagination.total
                    "
                    [createLink]="true"
                    (loadMore)="isRootLevelCollection() ? loadMoreCollections() : null"
                ></listTable>

                <!-- when empty at root level -->
                <div
                    *ngIf="collectionContent.collections.length == 0 && isRootLevelCollection()"
                    class="section-headline collection-nocontent-container"
                >
                    <div *ngIf="tabSelected == 'EDU_GROUPS'" class="collection-nocontent-big">
                        {{ 'collections_noOrgaCollections' | translate }}
                    </div>
                    <div *ngIf="tabSelected == 'EDU_ALL'" class="collection-nocontent-big">
                        {{ 'collections_noCollections' | translate }}
                    </div>
                </div>
            </section>

            <!-- content (content cards) if not error -->
            <section
                class="collections-cards-div"
                *ngIf="!isLoading && isReady && !isRootLevelCollection()"
            >
                <div class="section-headline">
                    <div>{{ 'collections_content' | translate }}</div>
                    <div
                        class="custom-order"
                        *ngIf="
                            !isMobile() &&
                            collectionContent.references &&
                            collectionContent.references.length > 1 &&
                            isUserAllowedToEdit(collectionContent.node)
                        "
                    >
                        <mat-slide-toggle
                            [ngModel]="collectionContent.node.collection.orderMode == 'custom'"
                            (change)="setCustomOrder($event)"
                        >
                            {{ 'COLLECTIONS.CUSTOM_ORDER' | translate }}
                        </mat-slide-toggle>
                    </div>
                    <actionbar
                        #actionbarReferences
                        class="actionbarMaterials"
                        [options]="optionsMaterials"
                        [numberOfAlwaysVisibleOptions]="1"
                    ></actionbar>
                </div>

                <app-custom-node-list-wrapper
                    *ngIf="customNodeList"
                    [parent]="collectionContent.node"
                    [nodes]="collectionContent.references"
                    [hasMore]="
                        collectionContent.references.length <
                        collectionContent.referencesPagination.total
                    "
                    [isLoading]="collectionContent.referencesLoading"
                    [mainNav]="mainNavRef"
                    [actionbar]="actionbarReferences"
                    (clickRow)="onContentClick($event.node)"
                    (loadMore)="loadMoreReferences()"
                    (requestRefresh)="refreshContent()"
                ></app-custom-node-list-wrapper>
                <listTable
                    *ngIf="!customNodeList"
                    [optionItems]="
                        isUserAllowedToEdit(collectionContent.node)
                            ? [addMaterialSearchOptionItem, addMaterialBinaryOptionItem]
                            : []
                    "
                    [hasHeading]="false"
                    [viewType]="1"
                    [dragDrop]="true"
                    [hasIcon]="true"
                    [orderElements]="isUserAllowedToEdit(collectionContent.node)"
                    [(orderElementsActive)]="orderActive"
                    [columns]="referencesColumns"
                    [mainNav]="mainNavRef"
                    [actionbar]="actionbarReferences"
                    [scope]="SCOPES.CollectionsReferences"
                    [isClickable]="true"
                    [hasCheckbox]="!orderActive && !reurl"
                    [canDrop]="canDropOnRef"
                    (clickRow)="onContentClick($event.node)"
                    [canDelete]="canDelete"
                    (onDelete)="deleteReference($event)"
                    [createLink]="true"
                    [(nodes)]="collectionContent.references"
                    [isLoading]="collectionContent.referencesLoading"
                    [hasMore]="
                        collectionContent.references.length <
                        collectionContent.referencesPagination.total
                    "
                    (loadMore)="loadMoreReferences()"
                ></listTable>

                <!-- NO CONTENT NOTICE -->
                <div
                    *ngIf="
                        collectionContent.references.length +
                            collectionContent.collections.length ==
                        0
                    "
                    class="section-headline collection-nocontent-container"
                >
                    <div class="collection-nocontent-big">
                        {{ 'collections_noContentAvailable' | translate }}
                    </div>
                    <div
                        class="collection-nocontent-small"
                        *ngIf="isUserAllowedToEdit(collectionContent.node)"
                    >
                        {{ 'collections_howToAddContent' | translate }}
                    </div>
                </div>
            </section>

            <section
                class="collections-cards-div"
                *ngIf="!isLoading && isReady && !isRootLevelCollection()"
                style="padding-bottom: 10px;"
            >
                <div *ngIf="collectionContent.references.length > 0" style="padding-top:8px;">
                    &nbsp;
                </div>
            </section>
        </div>

        <modal-dialog
            [title]="dialogTitle"
            [isCancelable]="dialogCancelable"
            (onCancel)="closeDialog()"
            [message]="dialogMessage"
            [buttons]="dialogButtons"
        ></modal-dialog>

        <workspace-management
            [(nodeReport)]="nodeReport"
            [(addToCollection)]="addToOther"
            [(nodeShare)]="collectionShare"
            (onCloseAddToCollection)="closeAddToOther()"
        ></workspace-management>
        <app-footer [scope]="'collections'" class="alignWithBanner"></app-footer>
    </div>
</div>
